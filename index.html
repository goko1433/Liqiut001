<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ProFinans v8 AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- PRO DESIGN SYSTEM v8 (Deep Space Glass) --- */
        :root {
            --bg-body: #08080A;
            --bg-card: #141416;
            --bg-glass: rgba(20, 20, 22, 0.7);
            
            --primary: #007AFF;
            --accent: #5E5CE6;
            --success: #32D74B;
            --danger: #FF453A;
            --warn: #FF9F0A;
            --gold: #FFD60A;
            
            --text-main: #FFFFFF;
            --text-muted: #8E8E93;
            
            --border-glass: 1px solid rgba(255, 255, 255, 0.08);
            --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.4);
            --glow-primary: 0 0 20px rgba(0, 122, 255, 0.3);
            
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            margin: 0; padding: 0;
            background: var(--bg-body);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- SPLASH SCREEN --- */
        #splash {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            transition: opacity 0.5s;
        }
        .logo-anim { width: 60px; height: 60px; border-radius: 16px; background: linear-gradient(45deg, var(--primary), var(--accent)); animation: pulseLogo 1.5s infinite; }
        @keyframes pulseLogo { 0% {transform:scale(0.95); opacity:0.8;} 50% {transform:scale(1.1); opacity:1;} 100% {transform:scale(0.95); opacity:0.8;} }

        /* --- HEADER --- */
        header {
            padding: max(10px, env(safe-area-inset-top)) 20px 10px 20px;
            background: rgba(8, 8, 10, 0.8); backdrop-filter: blur(20px);
            border-bottom: var(--border-glass); z-index: 100;
        }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .user-chip {
            display: flex; align-items: center; gap: 10px;
            background: rgba(255,255,255,0.05); padding: 6px 12px 6px 6px;
            border-radius: 30px; border: var(--border-glass);
        }
        .avatar {
            width: 32px; height: 32px; border-radius: 50%;
            background: linear-gradient(135deg, #FF2D55, #AF52DE);
            display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;
        }
        .u-name { font-size: 13px; font-weight: 600; }
        
        .sys-status { width: 8px; height: 8px; border-radius: 50%; background: #333; transition: 0.3s; box-shadow: 0 0 5px #333; }
        .sys-status.online { background: var(--success); box-shadow: 0 0 8px var(--success); }

        /* TICKER SCROLL */
        .ticker-cont { overflow-x: auto; display: flex; gap: 10px; scrollbar-width: none; padding-bottom: 5px; }
        .ticker-cont::-webkit-scrollbar { display: none; }
        .tick-pill {
            background: var(--bg-card); min-width: 100px; padding: 8px 12px;
            border-radius: 12px; border: var(--border-glass);
            display: flex; flex-direction: column; gap: 2px;
        }
        .tp-head { font-size: 10px; color: var(--text-muted); font-weight: 700; letter-spacing: 0.5px; }
        .tp-val { font-size: 14px; font-weight: 700; font-variant-numeric: tabular-nums; }
        .flash-green { color: var(--success); animation: flashG 1s; }
        .flash-red { color: var(--danger); animation: flashR 1s; }
        @keyframes flashG { 0%{text-shadow:0 0 10px var(--success);} 100%{text-shadow:none;} }
        @keyframes flashR { 0%{text-shadow:0 0 10px var(--danger);} 100%{text-shadow:none;} }

        /* --- MAIN --- */
        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
        .tab-view { display: none; animation: fadeIn 0.4s ease; }
        .tab-view.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

        /* CARDS */
        .card {
            background: var(--bg-card); border-radius: 24px; padding: 24px;
            border: var(--border-glass); margin-bottom: 20px;
            box-shadow: var(--shadow-card); position: relative; overflow: hidden;
        }
        .card-bg-fx {
            position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(0,122,255,0.08) 0%, transparent 60%);
            pointer-events: none;
        }

        /* HERO BALANCE */
        .lbl-sm { font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 700; letter-spacing: 1px; display: block; margin-bottom: 8px; }
        .big-bal {
            font-size: 40px; font-weight: 800; letter-spacing: -1px; margin-bottom: 20px;
            background: linear-gradient(180deg, #fff, #a5a5a5);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            cursor: pointer;
        }
        .progress-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin-top: 10px; }
        .prog-fill { height: 100%; width: 0%; background: var(--primary); border-radius: 10px; box-shadow: var(--glow-primary); transition: width 0.5s linear; }

        /* AI CARD */
        .ai-card {
            background: linear-gradient(135deg, rgba(94,92,230,0.15), rgba(0,0,0,0));
            border: 1px solid rgba(94,92,230,0.3);
            display: flex; gap: 15px; align-items: flex-start;
        }
        .ai-icon {
            width: 40px; height: 40px; background: rgba(94,92,230,0.2);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-size: 20px; flex-shrink: 0;
        }
        .ai-text h4 { margin: 0 0 4px 0; font-size: 15px; color: #fff; }
        .ai-text p { margin: 0; font-size: 12px; color: #ccc; line-height: 1.4; }

        /* GRID BUTTONS */
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 25px; }
        .g-btn {
            background: rgba(255,255,255,0.03); border-radius: 18px; padding: 15px 5px;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            border: var(--border-glass); transition: 0.2s; cursor: pointer;
        }
        .g-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.08); }
        .gb-icon { font-size: 24px; }
        .gb-lbl { font-size: 11px; font-weight: 600; }

        /* LISTS */
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .lh-title { font-size: 18px; font-weight: 700; }
        .lh-act { font-size: 12px; color: var(--primary); font-weight: 700; cursor: pointer; padding: 5px 10px; background: rgba(0,122,255,0.15); border-radius: 10px; }
        
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; background: var(--bg-card); border-radius: 18px;
            border: var(--border-glass); margin-bottom: 10px;
        }
        .li-left { display: flex; gap: 12px; align-items: center; }
        .li-icon { width: 40px; height: 40px; border-radius: 12px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .li-txt h3 { margin: 0; font-size: 15px; font-weight: 600; }
        .li-txt p { margin: 2px 0 0 0; font-size: 11px; color: var(--text-muted); }
        .li-val { text-align: right; font-size: 15px; font-weight: 700; }

        /* GOALS BAR */
        .goal-item { margin-bottom: 15px; background: var(--bg-card); padding: 15px; border-radius: 18px; border: var(--border-glass); }
        .gi-head { display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; margin-bottom: 8px; }
        .gi-track { height: 8px; background: #222; border-radius: 4px; overflow: hidden; }
        .gi-fill { height: 100%; background: linear-gradient(90deg, var(--gold), #FF9F0A); border-radius: 4px; }

        /* NAV */
        .btm-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(8, 8, 10, 0.9); backdrop-filter: blur(20px);
            border-top: var(--border-glass);
            display: flex; justify-content: space-around;
            padding: 10px 0 max(15px, var(--safe-bottom)) 0; z-index: 90;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            width: 20%; color: #666; cursor: pointer; transition: 0.3s;
        }
        .nav-item svg { width: 24px; height: 24px; fill: currentColor; }
        .nav-item span { font-size: 10px; font-weight: 600; }
        .nav-item.active { color: var(--primary); }

        /* MODALS */
        .modal-wrap {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200;
            opacity: 0; pointer-events: none; transition: 0.3s;
            display: flex; align-items: flex-end; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal-wrap.open { opacity: 1; pointer-events: auto; }
        .modal-sheet {
            width: 100%; max-width: 600px; background: #1C1C1E;
            border-radius: 30px 30px 0 0; padding: 25px; padding-bottom: 50px;
            transform: translateY(100%); transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            border-top: 1px solid #333;
        }
        .modal-wrap.open .modal-sheet { transform: translateY(0); }
        
        input, select {
            width: 100%; padding: 16px; margin-bottom: 15px;
            background: #2C2C2E; border: none; border-radius: 14px;
            color: #fff; font-size: 16px; font-family: inherit;
        }
        .btn-full {
            width: 100%; padding: 16px; background: var(--primary); color: #fff;
            border: none; border-radius: 14px; font-size: 16px; font-weight: 700;
            cursor: pointer; box-shadow: var(--glow-primary);
        }

        /* UTILS */
        .hidden { display: none; }
        .flex-row { display: flex; gap: 10px; }
    </style>
</head>
<body>

    <!-- SPLASH SCREEN -->
    <div id="splash"><div class="logo-anim"></div><h2 style="margin-top:20px;">ProFinans v8</h2></div>

    <!-- HEADER -->
    <header>
        <div class="top-bar">
            <div class="user-chip" onclick="modal('m-settings')">
                <div class="avatar" id="u-av">U</div>
                <div style="display:flex; flex-direction:column;">
                    <span class="u-name" id="u-name">Misafir</span>
                    <div style="display:flex; align-items:center; gap:4px; font-size:10px; color:#888;">
                        <div class="sys-status" id="ws-stat"></div> <span id="ws-txt">Baƒülanƒ±yor...</span>
                    </div>
                </div>
            </div>
            <div class="g-btn" style="padding:10px; border-radius:12px; width:40px; height:40px;" onclick="modal('m-settings')">
                ‚öôÔ∏è
            </div>
        </div>
        
        <div class="ticker-cont">
            <div class="tick-pill" id="tk-usd">
                <span class="tp-head">üá∫üá∏ USD/TRY</span>
                <span class="tp-val">--.--</span>
            </div>
            <div class="tick-pill" id="tk-eur">
                <span class="tp-head">üá™üá∫ EUR/TRY</span>
                <span class="tp-val">--.--</span>
            </div>
            <div class="tick-pill" id="tk-gold">
                <span class="tp-head">ü•á GR.ALTIN</span>
                <span class="tp-val">--.--</span>
            </div>
            <div class="tick-pill" id="tk-btc">
                <span class="tp-head">‚Çø BTC/USD</span>
                <span class="tp-val">--.--</span>
            </div>
        </div>
    </header>

    <main>
        <!-- TAB 1: DASHBOARD -->
        <div id="tab-home" class="tab-view active">
            
            <!-- Main Balance Card -->
            <div class="card">
                <div class="card-bg-fx"></div>
                <span class="lbl-sm">ANLIK HARCANABƒ∞Lƒ∞R NET BAKƒ∞YE</span>
                <div class="big-bal" id="val-bal" onclick="togglePriv()">‚Ç∫0,00</div>
                <div style="display:flex; justify-content:space-between; font-size:11px; color:#888;">
                    <span id="txt-start">Ba≈ülangƒ±√ß</span>
                    <span id="txt-pct">%0</span>
                    <span id="txt-end">Biti≈ü</span>
                </div>
                <div class="progress-bar"><div class="prog-fill" id="bar-fill"></div></div>
            </div>

            <!-- AI Insight Card (New) -->
            <div class="card ai-card">
                <div class="ai-icon">ü§ñ</div>
                <div class="ai-text">
                    <h4>AI Finans Asistanƒ±</h4>
                    <p id="ai-msg">Verilerinizi analiz ediyorum...</p>
                </div>
            </div>

            <!-- Actions -->
            <div class="grid-4">
                <div class="g-btn" onclick="modal('m-exp')">
                    <span class="gb-icon" style="color:#FF453A">üìâ</span>
                    <span class="gb-lbl">Gider</span>
                </div>
                <div class="g-btn" onclick="modal('m-asset')">
                    <span class="gb-icon" style="color:#32D74B">üí∞</span>
                    <span class="gb-lbl">Varlƒ±k</span>
                </div>
                <div class="g-btn" onclick="nav('tab-tools')">
                    <span class="gb-icon" style="color:#007AFF">üßÆ</span>
                    <span class="gb-lbl">Ara√ßlar</span>
                </div>
                <div class="g-btn" onclick="modal('m-goal')">
                    <span class="gb-icon" style="color:#FFD60A">üéØ</span>
                    <span class="gb-lbl">Hedef</span>
                </div>
            </div>

            <!-- Expense Flow -->
            <div class="list-header">
                <span class="lh-title">Gider Akƒ±≈üƒ±</span>
                <span class="lh-act" onclick="modal('m-exp')">+ Ekle</span>
            </div>
            <div id="list-exp"></div>
        </div>

        <!-- TAB 2: ASSETS -->
        <div id="tab-assets" class="tab-view">
            <div class="list-header"><span class="lh-title">Portf√∂y√ºm</span></div>
            <div class="card" style="text-align:center;">
                <span class="lbl-sm">TOPLAM VARLIK DEƒûERƒ∞</span>
                <h1 style="margin:10px 0;" id="val-networth">‚Ç∫0,00</h1>
            </div>
            <div id="list-asset"></div>
        </div>

        <!-- TAB 3: GOALS (New) -->
        <div id="tab-goals" class="tab-view">
            <div class="list-header">
                <span class="lh-title">Hedeflerim</span>
                <span class="lh-act" onclick="modal('m-goal')">+ Yeni</span>
            </div>
            <div id="list-goals">
                <div style="text-align:center; padding:40px; color:#666;">Hen√ºz bir hedef belirlemedin.</div>
            </div>
        </div>

        <!-- TAB 4: TOOLS (New) -->
        <div id="tab-tools" class="tab-view">
            <div class="list-header"><span class="lh-title">Ara√ßlar</span></div>
            
            <!-- Converter -->
            <div class="card">
                <h3 style="margin-top:0;">D√∂viz √áevirici</h3>
                <div class="flex-row">
                    <input type="number" id="conv-amt" placeholder="Miktar" oninput="convert()" value="1">
                    <select id="conv-curr" onchange="convert()" style="width:100px;">
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
                <div style="font-size:24px; font-weight:700; color:var(--primary);" id="conv-res">‚Ç∫32.00</div>
            </div>

            <!-- Analysis Stats -->
            <div class="card">
                <h3 style="margin-top:0;">Finansal Saƒülƒ±k</h3>
                <div class="list-item" style="background:transparent; padding:0;">
                    <span>Gelir/Gider Dengesi</span>
                    <span id="stat-ratio" style="font-weight:700;">%0</span>
                </div>
                <div class="list-item" style="background:transparent; padding:0;">
                    <span>Kalan Net Maa≈ü</span>
                    <span id="stat-net">‚Ç∫0</span>
                </div>
            </div>
        </div>

    </main>

    <!-- BOTTOM NAV -->
    <nav class="btm-nav">
        <div class="nav-item active" id="btn-home" onclick="nav('tab-home')">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span>√ñzet</span>
        </div>
        <div class="nav-item" id="btn-assets" onclick="nav('tab-assets')">
            <svg viewBox="0 0 24 24"><path d="M4 10h3v7H4zM22 8.16L18.47 18a3.001 3.001 0 0 1-5.63.12l-1.48-3.95-3.95-1.48a3.001 3.001 0 0 1 .12-5.63L17.34 3.65c.98-.35 1.99.66 1.64 1.64.01 0 2.06 1.76 3.02 2.87z"/></svg>
            <span>Varlƒ±k</span>
        </div>
        <div class="nav-item" id="btn-goals" onclick="nav('tab-goals')">
            <svg viewBox="0 0 24 24"><path d="M19.03 3.56c-1.67-1.39-3.74-2.3-6.03-2.51v2.01c1.73.19 3.31.88 4.62 1.92l1.41-1.42zM11 3.05v2.01c-2.29.21-4.36 1.12-6.03 2.51l1.42 1.42C7.69 7.95 9.27 7.26 11 7.07zm9 13.95h-6v-3h-4v3H4v2h16v-2zm-3.56-8.5l-1.42 1.42c1.05 1.31 1.73 2.89 1.92 4.62h2.01c-.21-2.29-1.12-4.36-2.51-6.04z"/></svg>
            <span>Hedef</span>
        </div>
        <div class="nav-item" id="btn-tools" onclick="nav('tab-tools')">
            <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM7 7h2v2H7V7zm0 4h2v2H7v-2zm0 4h2v2H7v-2zm6 2h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2zm4 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/></svg>
            <span>Ara√ßlar</span>
        </div>
    </nav>

    <!-- MODAL: SETTINGS -->
    <div class="modal-wrap" id="m-settings">
        <div class="modal-sheet">
            <h2>Ayarlar</h2>
            <input type="text" id="inp-name" placeholder="Adƒ±nƒ±z">
            <input type="number" id="inp-sal" placeholder="Net Maa≈ü (TL)">
            <div class="flex-row">
                <input type="number" id="inp-day" placeholder="Maa≈ü G√ºn√º (1-31)" min="1" max="31">
                <input type="number" id="inp-hour" placeholder="Saat (0-23)" min="0" max="23">
            </div>
            <button class="btn-full" onclick="saveSet()">Kaydet</button>
            <div style="text-align:center; margin-top:20px; color:var(--danger); font-size:12px;" onclick="resetApp()">Uygulamayƒ± Sƒ±fƒ±rla</div>
            <div style="text-align:center; margin-top:10px; color:#666;" onclick="closeModal('m-settings')">Kapat</div>
        </div>
    </div>

    <!-- MODAL: EXPENSE -->
    <div class="modal-wrap" id="m-exp">
        <div class="modal-sheet">
            <h2>Gider Ekle</h2>
            <input type="text" id="ex-name" placeholder="Ba≈ülƒ±k (√ñrn: Kira)">
            <input type="number" id="ex-amt" placeholder="Tutar (TL)">
            <button class="btn-full" onclick="addExp()">Ekle</button>
            <div style="text-align:center; margin-top:15px; color:#666;" onclick="closeModal('m-exp')">ƒ∞ptal</div>
        </div>
    </div>

    <!-- MODAL: ASSET -->
    <div class="modal-wrap" id="m-asset">
        <div class="modal-sheet">
            <h2>Varlƒ±k Ekle</h2>
            <select id="as-type">
                <option value="USD">Amerikan Dolarƒ± ($)</option>
                <option value="EUR">Euro (‚Ç¨)</option>
                <option value="GOLD">Gram Altƒ±n</option>
                <option value="BTC">Bitcoin</option>
                <option value="TRY">Nakit TL</option>
            </select>
            <input type="number" id="as-amt" placeholder="Miktar (Adet)">
            <button class="btn-full" onclick="addAs()">Ekle</button>
            <div style="text-align:center; margin-top:15px; color:#666;" onclick="closeModal('m-asset')">ƒ∞ptal</div>
        </div>
    </div>

    <!-- MODAL: GOAL -->
    <div class="modal-wrap" id="m-goal">
        <div class="modal-sheet">
            <h2>Hedef Ekle</h2>
            <input type="text" id="gl-name" placeholder="Hedef (√ñrn: Araba)">
            <input type="number" id="gl-target" placeholder="Hedef Tutar (TL)">
            <input type="number" id="gl-curr" placeholder="≈ûu anki Birikim (TL)">
            <button class="btn-full" style="background:var(--gold); color:#000;" onclick="addGoal()">Hedef Olu≈ütur</button>
            <div style="text-align:center; margin-top:15px; color:#666;" onclick="closeModal('m-goal')">ƒ∞ptal</div>
        </div>
    </div>

    <script>
        // --- CORE & DATA ---
        let app = {
            name: 'Kullanƒ±cƒ±', salary: 0, day: 1, hour: 9,
            expenses: [], assets: [], goals: []
        };
        let rates = { USD:32.0, EUR:34.5, GOLD:2000, BTC:40000, TRY:1 };
        let privMode = false;

        // --- INIT ---
        window.onload = () => {
            const saved = localStorage.getItem('PF_v8_Data');
            if(saved) app = JSON.parse(saved);
            if(!app.goals) app.goals = []; // Migration fix

            setTimeout(() => document.getElementById('splash').style.opacity = '0', 1000);
            setTimeout(() => document.getElementById('splash').style.display = 'none', 1500);

            startBinance();
            renderAll();
            requestAnimationFrame(tickLoop);
        };

        // --- AI LOGIC ---
        function runAI() {
            const totalExp = app.expenses.reduce((a,b)=>a+b.amt,0);
            const net = app.salary - totalExp;
            const ratio = app.salary > 0 ? (totalExp/app.salary*100) : 0;
            const msgEl = document.getElementById('ai-msg');
            
            let msgs = [];
            if(app.salary === 0) msgs.push("Ayarlar men√ºs√ºnden maa≈üƒ±nƒ± girerek analizi ba≈ülatabilirsin.");
            else {
                if(ratio > 90) msgs.push("Dikkat! Gelirinin %90'ƒ±ndan fazlasƒ± sabit gidere gidiyor.");
                else if(ratio < 50) msgs.push("Harika! Gelirinin yarƒ±sƒ±nƒ± tasarruf edebilirsin.");
                
                if(net > 0 && app.assets.length === 0) msgs.push("Nakit fazlan var ama yatƒ±rƒ±mƒ±n yok. Altƒ±n veya D√∂viz d√º≈ü√ºnebilirsin.");
                
                const goal = app.goals[0];
                if(goal) {
                    const months = Math.ceil((goal.target - goal.current) / (net * 0.5)); // Assuming 50% savings
                    if(months > 0) msgs.push(`"${goal.name}" hedefine mevcut hƒ±zla yakla≈üƒ±k ${months} ayda ula≈üabilirsin.`);
                }
            }
            
            msgEl.innerText = msgs.length > 0 ? msgs[Math.floor(Math.random()*msgs.length)] : "Finansal durumun stabil g√∂r√ºn√ºyor.";
        }

        // --- MARKET DATA ---
        function startBinance() {
            const ws = new WebSocket("wss://stream.binance.com:9443/stream?streams=usdttry@miniTicker/eurusdt@miniTicker/paxgusdt@miniTicker/btcusdt@miniTicker");
            ws.onopen = () => {
                document.getElementById('ws-stat').classList.add('online');
                document.getElementById('ws-txt').innerText = "Canlƒ±";
            };
            ws.onmessage = (e) => {
                const d = JSON.parse(e.data);
                const p = parseFloat(d.data.c);
                const s = d.stream;
                
                if(s.includes('usdttry')) updateRate('USD', p, 'tk-usd', '$');
                if(s.includes('eurusdt')) updateRate('EUR', p * rates.USD, 'tk-eur', '‚Ç¨'); // Approx
                if(s.includes('paxgusdt')) updateRate('GOLD', (p * rates.USD)/31.1035, 'tk-gold', '‚Ç∫');
                if(s.includes('btcusdt')) updateRate('BTC', p, 'tk-btc', '$');
            };
        }

        function updateRate(cur, val, elId, sym) {
            rates[cur] = val;
            const el = document.querySelector(`#${elId} .tp-val`);
            const old = parseFloat(el.getAttribute('d-val')) || val;
            el.innerText = sym + (cur==='BTC'?val.toLocaleString():val.toFixed(2));
            el.setAttribute('d-val', val);
            
            if(val !== old) {
                el.className = 'tp-val ' + (val > old ? 'flash-green' : 'flash-red');
                setTimeout(()=>el.className='tp-val', 1000);
            }
            if(document.getElementById('tab-assets').classList.contains('active')) renderAssets();
            if(document.getElementById('tab-tools').classList.contains('active')) convert();
        }

        // --- MAIN LOOP ---
        function tickLoop() {
            const now = new Date();
            let start = new Date(now.getFullYear(), now.getMonth(), app.day, app.hour, 0,0);
            if(now < start) start.setMonth(start.getMonth()-1);
            let end = new Date(start); end.setMonth(end.getMonth()+1);
            
            const pct = Math.min(1, Math.max(0, (now - start) / (end - start)));
            
            // Render Dashboard
            const totalExp = app.expenses.reduce((a,b)=>a+b.amt,0);
            const net = app.salary - totalExp;
            const live = net * pct;

            document.getElementById('val-bal').innerText = privMode ? '****' : fmt(live);
            document.getElementById('bar-fill').style.width = (pct*100)+'%';
            document.getElementById('txt-pct').innerText = '%'+(pct*100).toFixed(4);
            document.getElementById('txt-start').innerText = start.getDate() + ' ' + start.toLocaleString('default',{month:'short'});
            document.getElementById('txt-end').innerText = end.getDate() + ' ' + end.toLocaleString('default',{month:'short'});

            // Render Expense Counters
            app.expenses.forEach(ex => {
                const el = document.getElementById('ex-live-'+ex.id);
                if(el) el.innerText = privMode ? '***' : '-' + fmt(ex.amt * pct);
            });

            requestAnimationFrame(tickLoop);
        }

        // --- RENDER UI ---
        function renderAll() {
            document.getElementById('u-name').innerText = app.name;
            document.getElementById('u-av').innerText = app.name[0].toUpperCase();

            // Expenses
            const elExp = document.getElementById('list-exp');
            elExp.innerHTML = '';
            app.expenses.forEach(x => {
                elExp.innerHTML += `
                <div class="list-item">
                    <div class="li-left">
                        <div class="li-icon" style="color:#FF453A">üìâ</div>
                        <div class="li-txt"><h3>${x.name}</h3><p>Sabit: -${x.amt}‚Ç∫</p></div>
                    </div>
                    <div class="li-val" style="color:#FF453A" id="ex-live-${x.id}">...</div>
                    <div style="font-size:18px; color:#666; cursor:pointer;" onclick="delItem('exp', ${x.id})">√ó</div>
                </div>`;
            });

            renderAssets();
            renderGoals();
            runAI();

            // Tools Stats
            const totEx = app.expenses.reduce((a,b)=>a+b.amt,0);
            document.getElementById('stat-net').innerText = fmt(app.salary - totEx);
            document.getElementById('stat-ratio').innerText = app.salary ? '%' + ((totEx/app.salary)*100).toFixed(1) : '%0';
        }

        function renderAssets() {
            const elAs = document.getElementById('list-asset');
            elAs.innerHTML = '';
            let total = 0;
            app.assets.forEach(x => {
                let r = x.type==='BTC' ? rates.BTC*rates.USD : (rates[x.type]||1);
                let val = x.amt * r;
                total += val;
                let icon = x.type==='GOLD'?'ü•á':(x.type==='BTC'?'‚Çø':(x.type==='EUR'?'üí∂':'üíµ'));
                elAs.innerHTML += `
                <div class="list-item">
                    <div class="li-left">
                        <div class="li-icon" style="color:#32D74B">${icon}</div>
                        <div class="li-txt"><h3>${x.type}</h3><p>${x.amt} Adet</p></div>
                    </div>
                    <div class="li-val" style="color:#32D74B">${privMode?'***':fmt(val)}</div>
                    <div style="font-size:18px; color:#666; cursor:pointer;" onclick="delItem('as', ${x.id})">√ó</div>
                </div>`;
            });
            document.getElementById('val-networth').innerText = privMode ? '****' : fmt(total);
        }

        function renderGoals() {
            const elG = document.getElementById('list-goals');
            elG.innerHTML = '';
            if(app.goals.length === 0) {
                elG.innerHTML = '<div style="text-align:center; padding:20px; color:#444;">Hedef eklemek i√ßin + butonuna bas.</div>';
                return;
            }
            app.goals.forEach(g => {
                let pct = Math.min(100, (g.current / g.target)*100);
                elG.innerHTML += `
                <div class="goal-item">
                    <div class="gi-head">
                        <span>${g.name}</span>
                        <span>${fmt(g.current)} / ${fmt(g.target)}</span>
                    </div>
                    <div class="gi-track"><div class="gi-fill" style="width:${pct}%"></div></div>
                    <div style="text-align:right; margin-top:5px; font-size:11px; color:#888; cursor:pointer;" onclick="delItem('goal', ${g.id})">Sil</div>
                </div>`;
            });
        }

        // --- ACTIONS ---
        function modal(id) { document.getElementById(id).classList.add('open'); vibrate(); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        function nav(id) {
            document.querySelectorAll('.tab-view').forEach(e=>e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            if(id.includes('home')) document.getElementById('btn-home').classList.add('active');
            if(id.includes('assets')) document.getElementById('btn-assets').classList.add('active');
            if(id.includes('goals')) document.getElementById('btn-goals').classList.add('active');
            if(id.includes('tools')) document.getElementById('btn-tools').classList.add('active');
            vibrate();
            
            if(id === 'tab-assets') renderAssets();
        }

        function saveSet() {
            app.name = document.getElementById('inp-name').value || 'Kullanƒ±cƒ±';
            app.salary = parseFloat(document.getElementById('inp-sal').value) || 0;
            app.day = parseInt(document.getElementById('inp-day').value) || 1;
            app.hour = parseInt(document.getElementById('inp-hour').value) || 9;
            save(); closeModal('m-settings'); renderAll();
        }

        function addExp() {
            const n = document.getElementById('ex-name').value;
            const a = parseFloat(document.getElementById('ex-amt').value);
            if(n && a) { app.expenses.push({id:Date.now(), name:n, amt:a}); save(); closeModal('m-exp'); renderAll(); }
        }

        function addAs() {
            const t = document.getElementById('as-type').value;
            const a = parseFloat(document.getElementById('as-amt').value);
            if(a) { app.assets.push({id:Date.now(), type:t, amt:a}); save(); closeModal('m-asset'); renderAll(); }
        }

        function addGoal() {
            const n = document.getElementById('gl-name').value;
            const t = parseFloat(document.getElementById('gl-target').value);
            const c = parseFloat(document.getElementById('gl-curr').value);
            if(n && t) { app.goals.push({id:Date.now(), name:n, target:t, current:c||0}); save(); closeModal('m-goal'); renderAll(); }
        }

        function delItem(type, id) {
            if(!confirm('Silinsin mi?')) return;
            if(type==='exp') app.expenses = app.expenses.filter(x=>x.id!==id);
            if(type==='as') app.assets = app.assets.filter(x=>x.id!==id);
            if(type==='goal') app.goals = app.goals.filter(x=>x.id!==id);
            save(); renderAll();
        }

        function convert() {
            const amt = parseFloat(document.getElementById('conv-amt').value)||0;
            const cur = document.getElementById('conv-curr').value;
            const res = amt * rates[cur];
            document.getElementById('conv-res').innerText = fmt(res);
        }

        function togglePriv() { privMode=!privMode; renderAll(); vibrate(); }
        function save() { localStorage.setItem('PF_v8_Data', JSON.stringify(app)); }
        function fmt(n) { return '‚Ç∫' + n.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2}); }
        function vibrate() { if(navigator.vibrate) navigator.vibrate(10); }
        function resetApp() { if(confirm('T√ºm veriler silinecek!')) { localStorage.removeItem('PF_v8_Data'); location.reload(); }}

    </script>
</body>
</html>
